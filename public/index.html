<!DOCTYPE html>
<!-- Version 1.0.1 - Force deploy -->
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Island Gold - Caccia al Tesoro Multiplayer</title>
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Font Awesome per le icone -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Container principale del gioco -->
  <div id="game-container"></div>

  <!-- Schermata di caricamento -->
  <div id="loading-screen" class="screen">
    <div class="loading-content">
      <h1>Island Gold</h1>
      <div class="loading-bar">
        <div class="loading-progress"></div>
      </div>
      <p class="loading-text">Caricamento...</p>
      <div id="loading-errors" class="error-log"></div>
    </div>
  </div>

  <!-- Schermata iniziale -->
  <div id="start-screen" class="screen hidden">
    <div class="start-content">
      <h1>Island Gold</h1>
      <p>Un'avventura di caccia al tesoro multiplayer</p>
      <input type="text" id="player-name" placeholder="Inserisci il tuo nome">
      <button id="start-button">Inizia Gioco</button>
    </div>
  </div>

  <!-- Interfaccia di gioco -->
  <div id="game-ui" class="hidden">
    <!-- Barra della salute -->
    <div id="health-container">
      <div id="health-bar"></div>
    </div>

    <!-- Punteggio -->
    <div id="score-display">Punteggio: 0</div>

    <!-- Area notifiche -->
    <div id="notification-area"></div>

    <!-- Pannello di debug -->
    <div id="debug-panel" class="hidden"></div>
  </div>

  <!-- Importazione Three.js e moduli correlati -->
  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
    import { Water } from 'three/addons/objects/Water.js';
    import { Sky } from 'three/addons/objects/Sky.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // Rendi disponibili globalmente
    window.THREE = THREE;
    window.PointerLockControls = PointerLockControls;
    window.Water = Water;
    window.Sky = Sky;
    window.GLTFLoader = GLTFLoader;
  </script>
  
  <!-- Socket.io -->
  <script>
    // Inizializza socket.io con gestione degli errori
    window.initSocket = function() {
      try {
        // Configura socket.io per Render.com
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.hostname;
        const port = window.location.port || (protocol === 'wss:' ? '443' : '80');
        
        window.socket = io(`${protocol}//${host}:${port}`, {
          transports: ['websocket', 'polling'],
          upgrade: true,
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000
        });

        window.socket.on('connect', () => {
          console.log('Socket.io connesso con successo');
        });

        window.socket.on('connect_error', (error) => {
          logError(`Errore di connessione socket.io: ${error.message}`);
        });

        return true;
      } catch (error) {
        logError('Errore durante l\'inizializzazione di socket.io: ' + error.message);
        return false;
      }
    }
  </script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- Script di caricamento -->
  <script type="module">
    const loadingErrors = document.getElementById('loading-errors');
    
    function logError(message) {
      console.error(message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      loadingErrors.appendChild(errorDiv);
    }

    window.logError = logError;

    // Verifica il caricamento di Three.js e socket.io
    async function checkDependencies() {
      if (typeof THREE === 'undefined') {
        throw new Error('Three.js non è stato caricato');
      }
      
      if (typeof io === 'undefined') {
        throw new Error('Socket.io non è stato caricato');
      }

      if (!window.initSocket()) {
        throw new Error('Impossibile inizializzare socket.io');
      }

      // Verifica che tutti i moduli Three.js siano caricati
      const requiredModules = ['PointerLockControls', 'Water', 'Sky', 'GLTFLoader'];
      for (const module of requiredModules) {
        if (typeof window[module] === 'undefined') {
          throw new Error(`Il modulo ${module} non è stato caricato`);
        }
      }

      console.log('Tutte le dipendenze caricate con successo');
      return true;
    }

    // Carica uno script con gestione degli errori
    async function loadScript(src) {
      try {
        const script = document.createElement('script');
        script.type = 'module';
        script.src = src;
        
        const loaded = new Promise((resolve, reject) => {
          script.onload = resolve;
          script.onerror = () => reject(new Error(`Errore nel caricamento: ${src}`));
        });
        
        document.body.appendChild(script);
        await loaded;
      } catch (error) {
        throw new Error(`Errore nel caricamento dello script ${src}: ${error.message}`);
      }
    }

    async function loadScripts() {
      try {
        await checkDependencies();
        
        const scripts = [
          { src: "https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js" },
          { src: "/js/core/EventBus.js" },
          { src: "/js/core/InputManager.js" },
          { src: "/js/utils/PerformanceMonitor.js" },
          { src: "/js/utils/QualitySettings.js" },
          { src: "/js/audio/AudioManager.js" },
          { src: "/js/ui/UIManager.js" },
          { src: "/js/scene/SceneManager.js" },
          { src: "/js/scene/Map.js" },
          { src: "/js/entities/Player.js" },
          { src: "/js/entities/Treasure.js" },
          { src: "/js/core/Game.js" },
          { src: "/js/effects/water.js" },
          { src: "/js/core/terrain.js" },
          { src: "/js/effects/particles.js" },
          { src: "/js/main.js" }
        ];

        const progressBar = document.querySelector('.loading-progress');
        const loadingText = document.querySelector('.loading-text');

        for (let i = 0; i < scripts.length; i++) {
          try {
            await loadScript(scripts[i].src);
            const progress = ((i + 1) / scripts.length) * 100;
            progressBar.style.width = `${progress}%`;
            loadingText.textContent = `Caricamento... ${Math.round(progress)}%`;
          } catch (error) {
            logError(error.message);
          }
        }

        console.log("Tutti gli script sono stati caricati");
        await initializeGame();
      } catch (error) {
        logError(`Errore durante il caricamento: ${error.message}`);
      }
    }

    async function initializeGame() {
      try {
        if (!window.EventBus) {
          throw new Error("EventBus non è stato caricato correttamente");
        }
        
        console.log("Inizializzazione del gioco...");
        const eventBus = new window.EventBus();
        
        // Verifica che tutte le classi necessarie siano disponibili
        const requiredClasses = [
          'SceneManager',
          'InputManager',
          'AudioManager',
          'UIManager',
          'PerformanceMonitor',
          'QualitySettings',
          'Game'
        ];

        for (const className of requiredClasses) {
          if (!window[className]) {
            throw new Error(`La classe ${className} non è stata caricata correttamente`);
          }
        }

        const game = new window.Game(
          eventBus,
          new window.SceneManager(),
          new window.InputManager(),
          new window.AudioManager(),
          new window.UIManager(),
          new window.PerformanceMonitor(),
          new window.QualitySettings()
        );
        
        await game.init();
        
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        
        console.log("Gioco inizializzato con successo");
      } catch (error) {
        logError(`Errore durante l'inizializzazione del gioco: ${error.message}`);
        console.error(error);
      }
    }

    // Avvia il caricamento quando il DOM è pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadScripts);
    } else {
      loadScripts();
    }
  </script>

  <style>
    .error-log {
      margin-top: 20px;
      color: #ff4444;
      font-family: monospace;
      text-align: left;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }
    
    .error-message {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #ff4444;
    }
  </style>
</body>
</html> 